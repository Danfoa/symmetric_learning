name: Sphinx Documentation Build

on:
  push:
    branches:
      - main
      - devel
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: docs-pages
  cancel-in-progress: false

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Build docs
        env:
          DOCS_BRANCH: ${{ github.ref_name }}
        run: make -C docs clean html

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0

      - name: Commit and push gh-pages
        working-directory: gh-pages
        run: |
          set -euxo pipefail
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          for attempt in 1 2 3 4 5; do
            git fetch origin gh-pages
            git checkout -B gh-pages origin/gh-pages

            BRANCH="${GITHUB_REF_NAME}"
            if [ "$BRANCH" = "main" ]; then
              # Stable docs at project root, while keeping branch sub-sites alive.
              rsync -a --delete \
                --exclude '.git/' \
                --exclude '.nojekyll' \
                --exclude 'devel/' \
                ../docs/_build/html/ ./
            else
              # Branch docs under /<branch>/ (e.g. /devel/).
              mkdir -p "${BRANCH}"
              rsync -a --delete ../docs/_build/html/ "${BRANCH}/"
              # If stable docs were never published yet, keep root URL alive.
              if [ ! -f index.html ]; then
                printf '%s\n' \
                  '<!doctype html>' \
                  '<html lang="en">' \
                  '  <head>' \
                  '    <meta charset="utf-8">' \
                  '    <meta http-equiv="refresh" content="0; url=./devel/">' \
                  '    <title>Symmetric Learning Docs</title>' \
                  '  </head>' \
                  '  <body>' \
                  '    <p>Redirecting to <a href="./devel/">devel documentation</a>...</p>' \
                  '  </body>' \
                  '</html>' > index.html
              fi
            fi
            touch .nojekyll

            if [ -z "$(git status --porcelain)" ]; then
              echo "No documentation changes to publish."
              exit 0
            fi

            git add -A
            git commit -m "docs: update ${GITHUB_REF_NAME} (${GITHUB_SHA::7})"
            if git push origin HEAD:gh-pages; then
              exit 0
            fi
            echo "Push failed on attempt ${attempt}; retrying..."
            sleep $((attempt * 2))
          done
          echo "Failed to publish docs after 5 attempts."
          exit 1
